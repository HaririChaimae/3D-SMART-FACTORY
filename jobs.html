{% extends "base.html" %}
{% block title %}Offres d'emploi - Entretien Automatis√© - Plateforme de Recrutement IA{% endblock %}

{% block content %}
<!-- Page Header -->
<section style="padding: 4rem 0; background: linear-gradient(135deg, var(--gray-50), var(--gray-100)); border-bottom: 1px solid var(--gray-200);">
    <div class="container">
        <div class="fade-in-up" style="text-align: center;">
            <h1 style="font-size: 3rem; font-weight: 800; color: var(--gray-800); margin-bottom: 1rem;">
                D√©couvrez les <span style="color: var(--primary-color);">meilleures</span> opportunit√©s
            </h1>
            <p style="font-size: 1.2rem; color: var(--gray-600); max-width: 600px; margin: 0 auto;">
                Trouvez le poste id√©al gr√¢ce √† notre intelligence artificielle de matching avanc√©
            </p>
        </div>
    </div>
</section>

<!-- Search and Filter Section -->
<section style="padding: 3rem 0; background: #ffffff;">
    <div class="container">
        <div class="card-professional slide-in-left">
            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 1rem; align-items: end;">
                <div class="form-group-professional">
                    <label class="form-label-professional">
                        <i class="fas fa-search" style="margin-right: 0.5rem;"></i>
                        Recherche
                    </label>
                    <input type="text" class="form-input-professional" placeholder="Poste, entreprise, comp√©tences..."
                           value="{{ search_term or '' }}" id="search-input">
                </div>

                <div class="form-group-professional">
                    <label class="form-label-professional">
                        <i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>
                        Localisation
                    </label>
                    <select class="form-select-professional" id="location-filter">
                        <option value="All">Toutes les localisations</option>
                        <option value="Paris">Paris</option>
                        <option value="Lyon">Lyon</option>
                        <option value="Marseille">Marseille</option>
                        <option value="Toulouse">Toulouse</option>
                        <option value="Remote">T√©l√©travail</option>
                    </select>
                </div>

                <div class="form-group-professional">
                    <label class="form-label-professional">
                        <i class="fas fa-briefcase" style="margin-right: 0.5rem;"></i>
                        Type de contrat
                    </label>
                    <select class="form-select-professional" id="type-filter">
                        <option value="All">Tous les types</option>
                        <option value="full-time">CDI</option>
                        <option value="part-time">CDD</option>
                        <option value="contract">Freelance</option>
                        <option value="internship">Stage</option>
                    </select>
                </div>

                <div class="form-group-professional">
                    <label class="form-label-professional">
                        <i class="fas fa-file-upload" style="margin-right: 0.5rem;"></i>
                        Votre CV
                    </label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="file" accept=".pdf,.docx" style="display: none;" id="cv-upload">
                        <label for="cv-upload" class="btn-professional" style="padding: 0.875rem 1rem; font-size: 14px; margin: 0;">
                            üìÑ Choisir CV
                        </label>
                        <button class="btn-professional" style="padding: 0.875rem 1rem; font-size: 14px;" id="match-btn">
                            üéØ Matcher
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Status Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<section style="padding: 1rem 0;">
    <div class="container">
        {% for category, message in messages %}
        <div class="alert-professional alert-{{ 'success' if category == 'success' else 'error' if category == 'error' else 'info' }}-professional">
            <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' if category == 'error' else 'info-circle' }}"></i>
            {{ message }}
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}
{% endwith %}

<!-- CV Skills Display -->
{% if cv_data and cv_data.skills %}
<section style="padding: 2rem 0;">
    <div class="container">
        <div class="alert-professional alert-success-professional">
            <i class="fas fa-check-circle"></i>
            <div style="margin-left: 1rem;">
                <div style="font-size: 18px; font-weight: 700; margin-bottom: 0.5rem;">CV analys√© avec succ√®s !</div>
                <div style="font-size: 14px; margin-bottom: 1rem;"><strong>Comp√©tences d√©tect√©es :</strong></div>
                <div>
                    {% for skill in cv_data.skills[:8] %}
                    <span class="skill-tag-professional">{{ skill }}</span>
                    {% endfor %}
                    {% if cv_data.skills|length > 8 %}
                    <span class="skill-tag-professional">+{{ cv_data.skills|length - 8 }} autres</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Results Header -->
{% if jobs %}
<section style="padding: 2rem 0;">
    <div class="container">
        <div class="alert-professional alert-info-professional">
            <i class="fas fa-chart-bar"></i>
            <div style="margin-left: 1rem;">
                <strong>{{ jobs|length }} offre{{ 's' if jobs|length > 1 else '' }} trouv√©e{{ 's' if jobs|length > 1 else '' }}</strong>
                {% if cv_data and matched_jobs %}
                - R√©sultats personnalis√©s bas√©s sur votre CV
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Jobs Grid -->
<section style="padding: 3rem 0;">
    <div class="container">
        {% if jobs %}
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 2rem;">
            {% for job in jobs %}
            <div class="card-professional fade-in-up job-card" 
                 data-title="{{ job.title }}"
                 data-company="{{ job.company_name or 'Entreprise' }}"
                 data-location="{{ job.location or 'Non sp√©cifi√©' }}"
                 data-type="{{ job.type or 'Non sp√©cifi√©' }}"
                 data-description="{{ job.description|e }}"
                 data-salary="{{ job.salary_currency or '‚Ç¨' }} {{ job.salary_from }} - {{ job.salary_to }}"
                 data-url="{{ url_for('apply_for_job', job_id=job.id) }}">
                <!-- Job Header -->
                <div style="display: flex; align-items: center; margin-bottom: 1.5rem;">
                    {% if job.recruiter_picture %}
                    <img src="data:image/png;base64,{{ job.recruiter_picture }}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 1rem; border: 3px solid var(--primary-color);">
                    {% else %}
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); display: flex; align-items: center; justify-content: center; margin-right: 1rem; color: white;">
                        <i class="fas fa-building"></i>
                    </div>
                    {% endif %}
                    <div>
                        <div style="font-size: 14px; color: var(--gray-500); margin-bottom: 0.25rem;">
                            {{ job.recruiter_name or 'Recruteur' }} ‚Ä¢ {{ job.posted or 'R√©cemment' }}
                        </div>
                        <div style="font-size: 12px; color: var(--gray-400);">
                            {{ job.company_name or 'Entreprise' }}
                        </div>
                    </div>
                </div>

                <!-- Job Title -->
                <h3 style="font-size: 1.5rem; font-weight: 700; color: var(--gray-800); margin-bottom: 1rem; line-height: 1.3;">
                    {{ job.title }}
                </h3>

                <!-- Job Meta -->
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                    <span style="display: flex; align-items: center; gap: 0.5rem; font-size: 14px; color: var(--gray-600);">
                        <i class="fas fa-map-marker-alt"></i>
                        {{ job.location or 'Non sp√©cifi√©' }}
                    </span>
                    <span style="display: flex; align-items: center; gap: 0.5rem; font-size: 14px; color: var(--gray-600);">
                        <i class="fas fa-briefcase"></i>
                        {{ job.type or 'Non sp√©cifi√©' }}
                    </span>
                </div>

                <!-- Job Description -->
                <p style="color: var(--gray-600); line-height: 1.6; margin-bottom: 1.5rem;">
                    {{ job.description[:150] }}{{ '...' if job.description|length > 150 else '' }}
                </p>

                <!-- Apply Button -->
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <a href="{{ url_for('apply_for_job', job_id=job.id) }}" class="btn-professional" style="flex: 1; text-align: center;">
                        <i class="fas fa-paper-plane"></i> Postuler maintenant
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="card-professional text-center fade-in-up">
            <div style="padding: 3rem;">
                <i class="fas fa-search" style="font-size: 4rem; color: var(--gray-300); margin-bottom: 1rem;"></i>
                <h3 style="color: var(--gray-600); margin-bottom: 1rem;">Aucune offre trouv√©e</h3>
                <p style="color: var(--gray-500); margin-bottom: 2rem;">
                    Essayez de modifier vos crit√®res de recherche ou uploadez votre CV pour des recommandations personnalis√©es.
                </p>
                <a href="{{ url_for('home') }}" class="btn-professional">
                    <i class="fas fa-home"></i> Retour √† l'accueil
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</section>

<!-- Modal -->
<div id="jobModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2 id="modal-title"></h2>
    <p><strong>Entreprise :</strong> <span id="modal-company"></span></p>
    <p><strong>Localisation :</strong> <span id="modal-location"></span></p>
    <p><strong>Type :</strong> <span id="modal-type"></span></p>
    <p><strong>Salaire :</strong> <span id="modal-salary"></span></p>
    <div id="modal-description" style="margin-top:1rem;"></div>
    <div style="margin-top:2rem; text-align:center;">
      <a id="modal-apply" href="#" class="btn-professional">
        <i class="fas fa-paper-plane"></i> Postuler maintenant
      </a>
    </div>
  </div>
</div>

<style>
    @media (max-width: 768px) {
        .card-professional {
            margin-bottom: 2rem;
        }

        .form-group-professional {
            margin-bottom: 1rem;
        }

        .form-input-professional,
        .form-select-professional {
            font-size: 16px; /* Prevent zoom on iOS */
        }
    }

    @media (max-width: 480px) {
        .card-professional {
            padding: 1.5rem;
        }

        .btn-professional {
            padding: 0.75rem 1rem;
            font-size: 14px;
        }
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background: #fff;
        padding: 2rem;
        border-radius: 12px;
        max-width: 600px;
        width: 90%;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        animation: fadeIn 0.3s ease;
    }
    .close-btn {
        float: right;
        font-size: 24px;
        cursor: pointer;
    }
    @keyframes fadeIn {
        from {opacity:0; transform: scale(0.9);}
        to {opacity:1; transform: scale(1);}
    }
</style>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // === Upload CV ===
    const cvUpload = document.getElementById('cv-upload');
    const matchBtn = document.getElementById('match-btn');
    if (cvUpload) {
        cvUpload.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const label = document.querySelector('label[for="cv-upload"]');
                label.innerHTML = `<i class="fas fa-file"></i> ${file.name}`;
                matchBtn.style.display = 'block';
            }
        });
    }

    // === Recherche / Filtres ===
    const searchInput = document.getElementById('search-input');
    const locationFilter = document.getElementById('location-filter');
    const typeFilter = document.getElementById('type-filter');
    function performSearch() {
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        const locationValue = locationFilter ? locationFilter.value : 'All';
        const typeValue = typeFilter ? typeFilter.value : 'All';
        const jobCards = document.querySelectorAll('.card-professional');
        let visibleCount = 0;
        jobCards.forEach(card => {
            if (card.querySelector('h3')) {
                const title = card.querySelector('h3').textContent.toLowerCase();
                const company = card.textContent.toLowerCase();
                const location = card.textContent.toLowerCase();
                const type = card.textContent.toLowerCase();
                const matchesSearch = !searchTerm || title.includes(searchTerm) || company.includes(searchTerm);
                const matchesLocation = locationValue === 'All' || location.includes(locationValue.toLowerCase());
                const matchesType = typeValue === 'All' || type.includes(typeValue.toLowerCase());
                if (matchesSearch && matchesLocation && matchesType) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            }
        });
        const resultsAlert = document.querySelector('.alert-info-professional');
        if (resultsAlert) {
            const countText = resultsAlert.querySelector('strong');
            if (countText) {
                countText.textContent = `${visibleCount} offre${visibleCount > 1 ? 's' : ''} trouv√©e${visibleCount > 1 ? 's' : ''}`;
            }
        }
    }
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(performSearch, 300);
        });
    }
    if (locationFilter) locationFilter.addEventListener('change', performSearch);
    if (typeFilter) typeFilter.addEventListener('change', performSearch);

    // === Match bouton ===
    if (matchBtn) {
        matchBtn.addEventListener('click', function() {
            if (!cvUpload.files[0]) {
                alert("Veuillez d'abord s√©lectionner un CV.");
                return;
            }
            const originalText = this.innerHTML;
            this.innerHTML = '<div class="loading-professional"></div> Analyse en cours...';
            this.disabled = true;
            const formData = new FormData();
            formData.append('cv_file', cvUpload.files[0]);
            fetch('/upload-cv', { method: 'POST', body: formData })
            .then(response => response.text())
            .then(html => {
                document.open(); document.write(html); document.close();
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert("Erreur lors de l'analyse du CV. Veuillez r√©essayer.", 'error');
                matchBtn.innerHTML = originalText;
                matchBtn.disabled = false;
            });
        });
    }
// === Modal ===
const modal = document.getElementById("jobModal");
const closeBtn = document.querySelector(".close-btn");
const applyBtn = document.getElementById("modal-apply");

document.querySelectorAll(".job-card").forEach(card => {
    card.addEventListener("click", () => {
        document.getElementById("modal-title").textContent = card.dataset.title;
        document.getElementById("modal-company").textContent = card.dataset.company;
        document.getElementById("modal-location").textContent = card.dataset.location;
        document.getElementById("modal-type").textContent = card.dataset.type;
        document.getElementById("modal-salary").textContent = card.dataset.salary;
        document.getElementById("modal-description").textContent = card.dataset.description;

        // injection du lien vers apply.html
        applyBtn.href = card.dataset.url;

        modal.style.display = "flex";
    });
});

closeBtn.onclick = () => modal.style.display = "none";
window.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; };

// ‚úÖ Correction : emp√™cher que le clic sur "Postuler maintenant" 
// soit bloqu√© par l'√©v√©nement de la carte
applyBtn.addEventListener("click", (e) => {
    e.stopPropagation(); // emp√™che le clic d‚Äô√™tre captur√© par la carte
    window.location.href = applyBtn.href; // redirection forc√©e
});



    // === Alerte ===
    function showAlert(message, type = 'info') {
        const alert = document.createElement('div');
        alert.className = `alert-professional alert-${type}-professional`;
        alert.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle"></i> ${message}`;
        const container = document.querySelector('.container');
        if (container) container.insertBefore(alert, container.firstChild);
        setTimeout(() => { alert.remove(); }, 5000);
    }
});
</script>
{% endblock %}
{% endblock %}
